## Tests for bson.nim module
import unittest

import bson

suite "BSON serializer/deserializer test suite":

  echo "\n BSON serializer/deserializer test suite\n"

  test "Creating empty document with constructor":
    let doc = newBsonDocument()
    check($doc == "{\n}")

  test "Creating empty document with `%*` operator":
    let doc = %*{}
    check($doc == "{\n}")

  test "Creating document with all available types":
    let doc = %*{
      "double": 5436.5436,
      "stringkey": "stringvalue",
      "document": {
        "double": 5436.5436,
        "key": "value"
      },
      "array": [1, 2, 3],
      "int32": 5436'i32,
      "int64": 5436,
    }
    check(doc["double"] == 5436.5436)
    check(doc["stringkey"] == "stringvalue")
    check(doc["document"]["double"] == 5436.5436)
    check(doc["document"]["key"] == "value")
    check(doc["array"][0] == 1'i64)
    check(doc["int32"] == 5436'i32)
    check(doc["int64"] == 5436'i64)

  test "Document modification usin `[]=` operator":
    let doc = %*{
      "int32": 1'i32,
      "array": [1, 2, 3]
    }
    check(doc["int32"] == 1'i32)
    doc["int32"] = 2'i32
    check(doc["int32"] == 2'i32)
    doc["array"][0] = 10'i32
    check(doc["array"][0] == 10'i32)
    doc["newfield"] = "newvalue"
    check(doc["newfield"] == "newvalue")


  test "Check if document has specific field with `in` operator":
    let doc = %*{
      "field1": "string",
      "field2": 1'i32
    }
    check("field1" in doc)
    check(not ("field3" in doc))

<<<<<<< 43d1401a1b9beabbb9a535072abb6a988d383a3c
  test "Document inside array":
    let doc = %*{
      "field": "value",
      "ar": [
        {
          "field1": 5'i32,
          "field2": "gello"
        },
        {
          "field": "hello"
        }
      ]
    }

=======
  test "Check if we can diff two Documents":
    let doc1 = %*{
      "double": 5436.5436,
      "stringkey": "stringvalue",
      "document": {
        "double": 5436.5436,
        "key": "value"
      },
      "array": [1, 2, 3],
      "int32": 5436'i32,
      "int64": 5436,
    }


    let doc2 = %*{
      "double": 300,
      "stringkey": "stringvalue",
      "document": {
        "double": 5436.5436,
        "key": "value"
      },
      "array": [1, 0, 3],
      "int32": 5436'i32,
      "newkey": 100
      }
    check(diff(doc1,doc2).count == 3)

>>>>>>> added len and diff to bson node
echo ""
